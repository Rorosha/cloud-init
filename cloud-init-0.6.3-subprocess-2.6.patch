From 8e9ef3fab3d42e76bb109b268f36d2a190ab248e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?P=C3=A1draig=20Brady?= <P@draigBrady.com>
Date: Wed, 27 Jun 2012 16:28:09 +0100
Subject: [PATCH] make subprocess usage python 2.6 compatible

---
 cloudinit/netinfo.py |   12 ++++++++++--
 cloudinit/util.py    |    4 +++-
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/cloudinit/netinfo.py b/cloudinit/netinfo.py
index 7e07812..fe9f0d5 100644
--- a/cloudinit/netinfo.py
+++ b/cloudinit/netinfo.py
@@ -21,10 +21,18 @@
 
 import subprocess
 
+def check_output(args):
+    proc = subprocess.Popen(args, stdout=subprocess.PIPE)
+    out, err = proc.communicate()
+    ret = proc.returncode
+    if ret:
+        raise subprocess.CalledProcessError(ret, ' '.join(args))
+    return out
+
 
 def netdev_info(empty=""):
     fields = ("hwaddr", "addr", "bcast", "mask")
-    ifcfg_out = str(subprocess.check_output(["ifconfig", "-a"]))
+    ifcfg_out = str(check_output(["ifconfig", "-a"]))
     devs = {}
     for line in ifcfg_out.splitlines():
         if len(line) == 0:
@@ -70,7 +78,7 @@ def netdev_info(empty=""):
 
 
 def route_info():
-    route_out = str(subprocess.check_output(["route", "-n"]))
+    route_out = str(check_output(["route", "-n"]))
     routes = []
     for line in route_out.splitlines()[1:]:
         if not line:
diff --git a/cloudinit/util.py b/cloudinit/util.py
index 4739741..d512952 100644
--- a/cloudinit/util.py
+++ b/cloudinit/util.py
@@ -228,7 +228,9 @@ def subp(args, input_=None):
         stderr=subprocess.PIPE, stdin=subprocess.PIPE)
     out, err = sp.communicate(input_)
     if sp.returncode is not 0:
-        raise subprocess.CalledProcessError(sp.returncode, args, (out, err))
+        _exc = subprocess.CalledProcessError(sp.returncode, args)
+        _exc.output = (out, err)
+        raise _exc
     return(out, err)
 
 
-- 
1.7.6.4

